import{D as E}from"./datetime-P2UEB0PT.js";import{G as J,E as H}from"./index-D-4Ec2E9.js";function L(t,e){return t.endsWith("_at")&&typeof e=="number"?E.fromSeconds(e):e}function M(t,e){return t.endsWith("_at")?Math.round(E.fromISO(e).toSeconds()):e}const p=typeof Buffer=="function",A=typeof TextDecoder=="function"?new TextDecoder:void 0,C=typeof TextEncoder=="function"?new TextEncoder:void 0,z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",y=Array.prototype.slice.call(z),m=(t=>{let e={};return t.forEach((o,r)=>e[o]=r),e})(y),W=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,u=String.fromCharCode.bind(String),q=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),Z=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),v=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),G=t=>{let e,o,r,s,n="";const a=t.length%3;for(let i=0;i<t.length;){if((o=t.charCodeAt(i++))>255||(r=t.charCodeAt(i++))>255||(s=t.charCodeAt(i++))>255)throw new TypeError("invalid character found");e=o<<16|r<<8|s,n+=y[e>>18&63]+y[e>>12&63]+y[e>>6&63]+y[e&63]}return a?n.slice(0,a-3)+"===".substring(a):n},P=typeof btoa=="function"?t=>btoa(t):p?t=>Buffer.from(t,"binary").toString("base64"):G,V=p?t=>Buffer.from(t).toString("base64"):t=>{let o=[];for(let r=0,s=t.length;r<s;r+=4096)o.push(u.apply(null,t.subarray(r,r+4096)));return P(o.join(""))},Y=t=>{if(t.length<2){var e=t.charCodeAt(0);return e<128?t:e<2048?u(192|e>>>6)+u(128|e&63):u(224|e>>>12&15)+u(128|e>>>6&63)+u(128|e&63)}else{var e=65536+(t.charCodeAt(0)-55296)*1024+(t.charCodeAt(1)-56320);return u(240|e>>>18&7)+u(128|e>>>12&63)+u(128|e>>>6&63)+u(128|e&63)}},K=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,Q=t=>t.replace(K,Y),S=p?t=>Buffer.from(t,"utf8").toString("base64"):C?t=>V(C.encode(t)):t=>P(Q(t)),jt=(t,e=!1)=>e?Z(S(t)):S(t),X=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,tt=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),o=e-65536;return u((o>>>10)+55296)+u((o&1023)+56320);case 3:return u((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return u((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},et=t=>t.replace(X,tt),rt=t=>{if(t=t.replace(/\s+/g,""),!W.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,o="",r,s;for(let n=0;n<t.length;)e=m[t.charAt(n++)]<<18|m[t.charAt(n++)]<<12|(r=m[t.charAt(n++)])<<6|(s=m[t.charAt(n++)]),o+=r===64?u(e>>16&255):s===64?u(e>>16&255,e>>8&255):u(e>>16&255,e>>8&255,e&255);return o},O=typeof atob=="function"?t=>atob(v(t)):p?t=>Buffer.from(t,"base64").toString("binary"):rt,ot=p?t=>q(Buffer.from(t,"base64")):t=>q(O(t).split("").map(e=>e.charCodeAt(0))),st=p?t=>Buffer.from(t,"base64").toString("utf8"):A?t=>A.decode(ot(t)):t=>et(O(t)),nt=t=>v(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),it=t=>st(nt(t));async function Et(){return await l.get(`${h}/account/captcha`).json()}async function vt(t){return await l.post(`${h}/account/register`,{json:t}).json()}async function Pt(t){return await l.post(`${h}/account/login`,{json:t}).json()}async function Ot(){return await l.post(`${h}/account/logout`).json()}async function at(){return await l.get(`${h}/account/profile`).json()}async function ut(){return await l.get(`${h}/account/institute`).json()}async function Ut(){return await l.get(`${h}/account/code`).json()}async function Dt(){return await l.post(`${h}/account/code`).json()}const[U,b]=J(H({id:null,account:null,nickname:null,token:null,info:null,permissions:[],institutes:[],warnedCodeGeneration:!1}),{name:"account"}),ct=t=>{b({token:t});const e=it(t.split(".")[1]),o=JSON.parse(e);b({id:o.id,account:o.account,nickname:o.nickname,permissions:o.permissions})},D=()=>{b({id:null,account:null,nickname:null,token:null,info:null,permissions:[],warnedCodeGeneration:!1})},Bt=()=>{U.token&&at().then(t=>{b({info:t})}).catch(()=>{D()})},Ft=async()=>{try{const t=await ut();b({institutes:t})}catch{}};class k extends Error{constructor(e,o,r){const s=e.status||e.status===0?e.status:"",n=e.statusText||"",a=`${s} ${n}`.trim(),i=a?`status code ${a}`:"an unknown error";super(`Request failed with ${i}`),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"request",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="HTTPError",this.response=e,this.request=o,this.options=r}}class B extends Error{constructor(e){super("Request timed out"),Object.defineProperty(this,"request",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="TimeoutError",this.request=e}}const g=t=>t!==null&&typeof t=="object",_=(...t)=>{for(const e of t)if((!g(e)||Array.isArray(e))&&e!==void 0)throw new TypeError("The `options` argument must be an object");return R({},...t)},F=(t={},e={})=>{const o=new globalThis.Headers(t),r=e instanceof globalThis.Headers,s=new globalThis.Headers(e);for(const[n,a]of s.entries())r&&a==="undefined"||a===void 0?o.delete(n):o.set(n,a);return o},R=(...t)=>{let e={},o={};for(const r of t)if(Array.isArray(r))Array.isArray(e)||(e=[]),e=[...e,...r];else if(g(r)){for(let[s,n]of Object.entries(r))g(n)&&s in e&&(n=R(e[s],n)),e={...e,[s]:n};g(r.headers)&&(o=F(o,r.headers),e.headers=o)}return e},ft=(()=>{let t=!1,e=!1;const o=typeof globalThis.ReadableStream=="function",r=typeof globalThis.Request=="function";return o&&r&&(e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type")),t&&!e})(),ht=typeof globalThis.AbortController=="function",lt=typeof globalThis.ReadableStream=="function",dt=typeof globalThis.FormData=="function",I=["get","post","put","patch","head","delete"],pt={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},x=2147483647,N=Symbol("stop"),yt={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},bt={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},mt=t=>I.includes(t)?t.toUpperCase():t,_t=["get","put","head","delete","options","trace"],gt=[408,413,429,500,502,503,504],$=[413,429,503],j={limit:2,methods:_t,statusCodes:gt,afterStatusCodes:$,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:t=>.3*2**(t-1)*1e3},wt=(t={})=>{if(typeof t=="number")return{...j,limit:t};if(t.methods&&!Array.isArray(t.methods))throw new Error("retry.methods must be an array");if(t.statusCodes&&!Array.isArray(t.statusCodes))throw new Error("retry.statusCodes must be an array");return{...j,...t,afterStatusCodes:$}};async function xt(t,e,o,r){return new Promise((s,n)=>{const a=setTimeout(()=>{o&&o.abort(),n(new B(t))},r.timeout);r.fetch(t,e).then(s).catch(n).then(()=>{clearTimeout(a)})})}async function Tt(t,{signal:e}){return new Promise((o,r)=>{e&&(e.throwIfAborted(),e.addEventListener("abort",s,{once:!0}));function s(){clearTimeout(n),r(e.reason)}const n=setTimeout(()=>{e?.removeEventListener("abort",s),o()},t)})}const Rt=(t,e)=>{const o={};for(const r in e)!(r in bt)&&!(r in yt)&&!(r in t)&&(o[r]=e[r]);return o};class w{static create(e,o){const r=new w(e,o),s=async()=>{if(typeof r._options.timeout=="number"&&r._options.timeout>x)throw new RangeError(`The \`timeout\` option cannot be greater than ${x}`);await Promise.resolve();let i=await r._fetch();for(const c of r._options.hooks.afterResponse){const f=await c(r.request,r._options,r._decorateResponse(i.clone()));f instanceof globalThis.Response&&(i=f)}if(r._decorateResponse(i),!i.ok&&r._options.throwHttpErrors){let c=new k(i,r.request,r._options);for(const f of r._options.hooks.beforeError)c=await f(c);throw c}if(r._options.onDownloadProgress){if(typeof r._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!lt)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return r._stream(i.clone(),r._options.onDownloadProgress)}return i},a=r._options.retry.methods.includes(r.request.method.toLowerCase())?r._retry(s):s();for(const[i,c]of Object.entries(pt))a[i]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||c);const d=(await a).clone();if(i==="json"){if(d.status===204||(await d.clone().arrayBuffer()).byteLength===0)return"";if(o.parseJson)return o.parseJson(await d.text())}return d[i]()};return a}constructor(e,o={}){Object.defineProperty(this,"request",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"abortController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_retryCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._input=e;const r=this._input instanceof Request&&"credentials"in Request.prototype?this._input.credentials:void 0;if(this._options={...r&&{credentials:r},...o,headers:F(this._input.headers,o.headers),hooks:R({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},o.hooks),method:mt(o.method??this._input.method),prefixUrl:String(o.prefixUrl||""),retry:wt(o.retry),throwHttpErrors:o.throwHttpErrors!==!1,timeout:o.timeout??1e4,fetch:o.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(ht){if(this.abortController=new globalThis.AbortController,this._options.signal){const s=this._options.signal;this._options.signal.addEventListener("abort",()=>{this.abortController.abort(s.reason)})}this._options.signal=this.abortController.signal}if(ft&&(this._options.duplex="half"),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const n="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),a=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,n);(dt&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(a,{...this.request}),this._options)}this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this.request.headers.set("content-type",this._options.headers.get("content-type")??"application/json"),this.request=new globalThis.Request(this.request,{body:this._options.body}))}_calculateRetryDelay(e){if(this._retryCount++,this._retryCount<=this._options.retry.limit&&!(e instanceof B)){if(e instanceof k){if(!this._options.retry.statusCodes.includes(e.response.status))return 0;const r=e.response.headers.get("Retry-After");if(r&&this._options.retry.afterStatusCodes.includes(e.response.status)){let s=Number(r);return Number.isNaN(s)?s=Date.parse(r)-Date.now():s*=1e3,this._options.retry.maxRetryAfter!==void 0&&s>this._options.retry.maxRetryAfter?0:s}if(e.response.status===413)return 0}const o=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,o)}return 0}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(o){const r=Math.min(this._calculateRetryDelay(o),x);if(r!==0&&this._retryCount>0){await Tt(r,{signal:this._options.signal});for(const s of this._options.hooks.beforeRetry)if(await s({request:this.request,options:this._options,error:o,retryCount:this._retryCount})===N)return;return this._retry(e)}throw o}}async _fetch(){for(const o of this._options.hooks.beforeRequest){const r=await o(this.request,this._options);if(r instanceof Request){this.request=r;break}if(r instanceof Response)return r}const e=Rt(this.request,this._options);return this._options.timeout===!1?this._options.fetch(this.request.clone(),e):xt(this.request.clone(),e,this.abortController,this._options)}_stream(e,o){const r=Number(e.headers.get("content-length"))||0;let s=0;return e.status===204?(o&&o({percent:1,totalBytes:r,transferredBytes:s},new Uint8Array),new globalThis.Response(null,{status:e.status,statusText:e.statusText,headers:e.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(n){const a=e.body.getReader();o&&o({percent:0,transferredBytes:0,totalBytes:r},new Uint8Array);async function i(){const{done:c,value:f}=await a.read();if(c){n.close();return}if(o){s+=f.byteLength;const d=r===0?0:s/r;o({percent:d,transferredBytes:s,totalBytes:r},f)}n.enqueue(f),await i()}await i()}}),{status:e.status,statusText:e.statusText,headers:e.headers})}}/*! MIT License © Sindre Sorhus */const T=t=>{const e=(o,r)=>w.create(o,_(t,r));for(const o of I)e[o]=(r,s)=>w.create(r,_(t,s,{method:o}));return e.create=o=>T(_(o)),e.extend=o=>T(_(t,o)),e.stop=N,e},At=T(),h="/api",l=At.extend({parseJson:t=>JSON.parse(t,L),stringifyJson:t=>JSON.stringify(t,M),hooks:{beforeRequest:[t=>{const e=U.token;e&&t.headers.set("Authorization",`Bearer ${e}`)}],afterResponse:[(t,e,o)=>{if(o.status===401&&D(),o.headers.has("Set-Token")){const r=o.headers.get("Set-Token");r&&ct(r)}}]}});export{U as a,Dt as b,D as c,l as d,h as e,Pt as f,Ut as g,vt as h,Et as i,jt as j,At as k,Ot as l,Ft as m,Bt as r,b as s};
